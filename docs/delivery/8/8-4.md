# [8-4] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that PBI-8's Conditions of Satisfaction are met. Test the full flow: endpoint definitions → OpenAPI spec generation → Prism container startup with mounted spec → mock endpoint responses → cross-service Docker DNS resolution.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 10:19:37 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all PBI-8 acceptance criteria:
1. Endpoint definitions (method, path, response schema) are translated into valid OpenAPI 3.0 specs
2. Generated specs pass OpenAPI validation
3. Prism container starts with a mounted spec and serves the defined endpoints
4. Mock responses contain data matching the defined response schemas
5. Cross-service HTTP calls resolve via Docker DNS within the shared network

## Implementation Plan

1. Create integration test file `backend/internal/docker/templates/api_service_integration_test.go` (or extend existing integration tests)
2. Test scenario:
   - Define a diagram with an API service node containing multiple endpoints (GET /users, POST /users, GET /users/{id})
   - Translate diagram through the full pipeline (Translator → ContainerConfigs)
   - Verify generated OpenAPI spec is valid (parse and check structure)
   - Use Docker orchestrator to create network and start the Prism container
   - Send HTTP requests to the running Prism container and verify:
     - Correct HTTP status codes (200 for defined endpoints)
     - Response bodies match defined schemas
     - Undefined endpoints return 404 or appropriate error
   - Test cross-service DNS: start a second container, verify it can reach the API service via hostname
   - Tear down all containers and network

## Test Plan

### Objectives
Full end-to-end verification of the mock API system with real Docker containers.

### Environment & Setup
- Requires Docker daemon running
- Uses `heph-network` Docker network
- Build tag: `integration` (consistent with existing integration tests)
- Cleanup: `TeardownAll` in test teardown to ensure no resource leaks

### Test Scope

#### AC1: OpenAPI Spec Generation
- Define endpoints with various methods and response schemas
- Generate spec via `openapi.GenerateSpec()`
- Parse output and verify: `openapi` field = "3.0.0", paths match input, response schemas match

#### AC2: Spec Validation
- Generated spec unmarshals to valid JSON
- Required OpenAPI fields present (openapi, info, paths)
- Path items contain correct operations and response definitions

#### AC3: Prism Container Serves Endpoints
- Start Prism container with mounted spec
- Wait for container health/readiness
- Send HTTP GET to defined endpoint → expect 200 with JSON response
- Send HTTP POST to defined endpoint → expect 200 with JSON response

#### AC4: Response Schema Matching
- Define endpoint with specific schema (e.g., `{"type": "object", "properties": {"id": {"type": "integer"}, "name": {"type": "string"}}}`)
- Verify Prism response body is valid JSON matching the schema structure

#### AC5: Cross-Service DNS Resolution
- Start two containers on the same network (e.g., API service + a curl/alpine helper)
- From the helper container, curl the API service via hostname (e.g., `http://user-service:4010/users`)
- Verify response is received (DNS resolves and Prism responds)

### Success Criteria
- All 5 acceptance criteria verified with passing tests
- No container or network resource leaks after test completion
- Tests are reproducible (idempotent setup/teardown)

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
