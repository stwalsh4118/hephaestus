# [8-4] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that PBI-8's Conditions of Satisfaction are met. Test the full flow: endpoint definitions → OpenAPI spec generation → Prism container startup with mounted spec → mock endpoint responses → cross-service Docker DNS resolution.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 10:19:37 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 13:46:42 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 13:55:59 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (2 medium findings resolved) | AI_Agent |
| 2026-02-20 05:12:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify all PBI-8 acceptance criteria:
1. Endpoint definitions (method, path, response schema) are translated into valid OpenAPI 3.0 specs
2. Generated specs pass OpenAPI validation
3. Prism container starts with a mounted spec and serves the defined endpoints
4. Mock responses contain data matching the defined response schemas
5. Cross-service HTTP calls resolve via Docker DNS within the shared network

## Implementation Plan

1. Create integration test file `backend/internal/docker/templates/api_service_integration_test.go` (or extend existing integration tests)
2. Test scenario:
   - Define a diagram with an API service node containing multiple endpoints (GET /users, POST /users, GET /users/{id})
   - Translate diagram through the full pipeline (Translator → ContainerConfigs)
   - Verify generated OpenAPI spec is valid (parse and check structure)
   - Use Docker orchestrator to create network and start the Prism container
   - Send HTTP requests to the running Prism container and verify:
     - Correct HTTP status codes (200 for defined endpoints)
     - Response bodies match defined schemas
     - Undefined endpoints return 404 or appropriate error
   - Test cross-service DNS: start a second container, verify it can reach the API service via hostname
   - Tear down all containers and network

## Test Plan

### Objectives
Full end-to-end verification of the mock API system with real Docker containers.

### Environment & Setup
- Requires Docker daemon running
- Uses `heph-network` Docker network
- Build tag: `integration` (consistent with existing integration tests)
- Cleanup: `TeardownAll` in test teardown to ensure no resource leaks

### Test Scope

#### AC1: OpenAPI Spec Generation
- Define endpoints with various methods and response schemas
- Generate spec via `openapi.GenerateSpec()`
- Parse output and verify: `openapi` field = "3.0.0", paths match input, response schemas match

#### AC2: Spec Validation
- Generated spec unmarshals to valid JSON
- Required OpenAPI fields present (openapi, info, paths)
- Path items contain correct operations and response definitions

#### AC3: Prism Container Serves Endpoints
- Start Prism container with mounted spec
- Wait for container health/readiness
- Send HTTP GET to defined endpoint → expect 200 with JSON response
- Send HTTP POST to defined endpoint → expect 200 with JSON response

#### AC4: Response Schema Matching
- Define endpoint with specific schema (e.g., `{"type": "object", "properties": {"id": {"type": "integer"}, "name": {"type": "string"}}}`)
- Verify Prism response body is valid JSON matching the schema structure

#### AC5: Cross-Service DNS Resolution
- Start two containers on the same network (e.g., API service + a curl/alpine helper)
- From the helper container, curl the API service via hostname (e.g., `http://user-service:4010/users`)
- Verify response is received (DNS resolves and Prism responds)

### Success Criteria
- All 5 acceptance criteria verified with passing tests
- No container or network resource leaks after test completion
- Tests are reproducible (idempotent setup/teardown)

## Verification

- All 5 E2E tests pass (`go test ./test/e2e/ -run TestPBI8 -v`)
  - AC1: OpenAPI spec generation — PASS
  - AC2: Spec validation (required fields, structure) — PASS
  - AC3: Prism container serves endpoints (GET, POST, health) — PASS (2.2s)
  - AC4: Response schema matching (id: integer, name: string) — PASS (2.1s)
  - AC5: Cross-service DNS resolution (curl helper → user-service:4010) — PASS (3.2s)
- Full suite: `go test ./...` — 0 failures
- `golangci-lint run ./...` — 0 issues
- Internal AI review: pass (0 critical, 0 high, 2 medium resolved, 5 low deferred)
  - Fixed: type assertion chain nil checks in AC1 test
  - Fixed: curl `--fail` flag for DNS test reliability
  - Fixed: AC4 response type verification (number/string)

## Files Modified

- `backend/test/e2e/mock_api_test.go` — New file with 5 E2E tests covering all PBI-8 acceptance criteria
