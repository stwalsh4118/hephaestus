# [8-2] OpenAPI 3.0 Spec Generator

[Back to task list](./tasks.md)

## Description

Create a Go package (`backend/internal/openapi/`) that takes a slice of `model.Endpoint` definitions (method, path, responseSchema) and produces a valid OpenAPI 3.0.0 JSON document. This is the core logic for PBI-8: turning user-defined endpoints into specs that Prism can serve.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 10:19:37 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 13:38:47 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 13:42:22 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 05:12:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. New package: `backend/internal/openapi/`
2. Export a function: `GenerateSpec(endpoints []model.Endpoint, title string) ([]byte, error)`
3. Output must be valid OpenAPI 3.0.0 JSON
4. Map each endpoint to an OpenAPI path+operation:
   - `Endpoint.Method` → HTTP method (GET, POST, PUT, DELETE, PATCH)
   - `Endpoint.Path` → OpenAPI path (e.g., `/users`, `/users/{id}`)
   - `Endpoint.ResponseSchema` → JSON Schema for the 200 response body
5. Group endpoints by path (multiple methods on the same path share a path item)
6. Handle `responseSchema` parsing:
   - Valid JSON object string → use as JSON Schema directly
   - Empty string → default to `{"type": "object"}` placeholder
   - Invalid JSON → wrap as `{"type": "string", "example": <raw value>}`
7. Set `application/json` as the response content type
8. Include required OpenAPI fields: `openapi`, `info`, `paths`

## Implementation Plan

1. Create `backend/internal/openapi/generator.go`:
   - Define internal structs for OpenAPI 3.0 document structure (spec, info, paths, operation, response, media type, schema)
   - Implement `GenerateSpec` function
   - Parse and validate responseSchema strings
   - Group endpoints by path
   - Marshal to indented JSON
2. Create `backend/internal/openapi/generator_test.go`:
   - Test single endpoint generation
   - Test multiple endpoints on same path
   - Test various responseSchema formats (valid JSON, empty, invalid)
   - Test output is valid JSON
   - Test required OpenAPI fields are present

## Test Plan

### Objectives
Verify the spec generator produces valid, correct OpenAPI 3.0 JSON from various endpoint configurations.

### Key Scenarios
1. **Single GET endpoint** — produces valid spec with one path and one operation
2. **Multiple methods on same path** — groups correctly under one path item
3. **Multiple different paths** — each gets its own path item
4. **Valid JSON Schema responseSchema** — embedded directly in response schema
5. **Empty responseSchema** — defaults to `{"type": "object"}`
6. **Invalid JSON responseSchema** — wrapped as string example
7. **Empty endpoints slice** — produces valid spec with empty paths
8. **All HTTP methods** — GET, POST, PUT, DELETE, PATCH all map correctly

### Success Criteria
- All generated specs contain `openapi: "3.0.0"`, `info`, and `paths`
- Response schemas match input definitions
- JSON output is well-formed and parseable

## Verification

- All 11 tests pass (`go test ./internal/openapi/ -v`)
- Full suite: `go test ./...` — 0 failures
- `go vet ./...` clean
- `golangci-lint run ./...` — 0 issues
- Internal AI review: pass (0 critical, 0 high, 0 medium, 5 low)

## Files Modified

- `backend/internal/openapi/generator.go` — New package with `GenerateSpec` function and internal OpenAPI structs
- `backend/internal/openapi/generator_test.go` — 11 test cases covering all scenarios from test plan
