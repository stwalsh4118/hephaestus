# [8-3] Integrate Spec Generation into API Service Template

[Back to task list](./tasks.md)

## Description

Update the `APIServiceTemplate.Build()` method to parse `ApiServiceConfig` from the node's config JSON, generate an OpenAPI spec using the generator from task 8-2, write the spec to a temp file on the host, and mount it into the Prism container. Configure Prism's command to run in mock mode pointing at the mounted spec.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 10:19:37 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 13:42:22 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 13:46:42 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (2 medium findings resolved) | AI_Agent |
| 2026-02-20 05:12:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Parse `model.ApiServiceConfig` from `node.Config` JSON in `APIServiceTemplate.Build()`
2. If endpoints are defined, call `openapi.GenerateSpec()` to produce the OpenAPI spec
3. Write the spec to a host-side temp directory (e.g., `os.TempDir()/heph-specs/<container-name>.json`)
4. Mount the spec file into the Prism container at `/tmp/spec.json` via `ContainerConfig.Volumes`
5. Set `ContainerConfig.Cmd` to `["mock", "-h", "0.0.0.0", "/tmp/spec.json"]` so Prism serves the spec
6. If no endpoints are defined, Prism should still start with a minimal empty spec (single health endpoint or empty paths)
7. Ensure the container's `Hostname` is set correctly for Docker DNS resolution (already handled by existing code)

## Implementation Plan

1. Update `backend/internal/docker/templates/api_service.go`:
   - Import `openapi` package and `model` config types
   - Parse `ApiServiceConfig` from `node.Config` (follow pattern from other templates like redis.go)
   - Call `openapi.GenerateSpec()` with parsed endpoints and node name as title
   - Create spec directory: `os.MkdirAll(filepath.Join(os.TempDir(), "heph-specs"), 0755)`
   - Write spec bytes to `<tempdir>/heph-specs/<container-name>.json`
   - Add volume mount: host spec path → `/tmp/spec.json`
   - Set Cmd: `["mock", "-h", "0.0.0.0", "/tmp/spec.json"]`
2. Update `backend/internal/docker/templates/templates_test.go`:
   - Test API service template with endpoint config
   - Test API service template with empty config
   - Verify Volumes and Cmd are set correctly
   - Verify spec file is written to expected location

## Test Plan

### Objectives
Verify the API service template correctly generates, writes, and mounts OpenAPI specs into Prism containers.

### Key Scenarios
1. **Node with endpoints** — spec file written, volume mounted, Cmd set for Prism mock mode
2. **Node without config** — still produces a valid container config with minimal spec
3. **Node with empty endpoints array** — handles gracefully with empty-paths spec
4. **Volume path correctness** — host path maps to `/tmp/spec.json` in container
5. **Cmd correctness** — Prism receives `mock -h 0.0.0.0 /tmp/spec.json`
6. **Hostname/DNS** — container hostname matches sanitized node name (existing behavior preserved)

### Success Criteria
- Template produces `ContainerConfig` with Volumes and Cmd populated
- Spec file is valid JSON written to the expected host path
- Existing template tests continue to pass
- Prism would receive correct arguments to serve the spec

## Verification

- All template tests pass (4 API service tests + all existing tests)
- Full suite: `go test ./...` — 0 failures
- `go vet ./...` clean
- `golangci-lint run ./...` — 0 issues
- Internal AI review: initial pass with 2 medium findings, both resolved:
  - Changed `prismCmd` from mutable package-level var to `newPrismCmd()` function returning fresh slice
  - Changed `parseEndpoints` to return error on invalid JSON (consistent with other templates)
  - Added `TestAPIServiceTemplate_Build_InvalidConfig` test

## Files Modified

- `backend/internal/docker/templates/api_service.go` — Rewrote to parse endpoint config, generate OpenAPI spec, write to disk, mount into Prism container
- `backend/internal/docker/templates/templates_test.go` — Added 4 new tests (NoConfig, WithEndpoints, EmptyEndpoints, InvalidConfig), added `os` import
