# [7-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that all PBI 7 acceptance criteria are met. Create comprehensive tests that exercise the full service-to-container mapping pipeline with realistic diagram inputs.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:34:42 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:38:15 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

Verify all 6 acceptance criteria from the PBI:

1. **AC1**: Each of the 5 service types has a container template that produces valid Docker configurations
2. **AC2**: Templates use correct official Docker images for each service type
3. **AC3**: Service-specific configuration (env vars, volumes, ports) is correctly applied
4. **AC4**: Dependency ordering ensures databases and caches start before services that depend on them
5. **AC5**: Port allocation assigns unique host ports without conflicts
6. **AC6**: A diagram with all 5 service types can be translated into container configs that the orchestration engine accepts

## Implementation Plan

- Create integration test file: `backend/internal/docker/templates/translator_integration_test.go`
- Test scenarios:
  - **Full diagram test**: Construct a `model.Diagram` with all 5 service types and realistic edges, translate it, verify all configs
  - **Image verification**: Assert each config uses the expected Docker image
  - **Config verification**: Assert environment variables, ports, and hostnames are correctly set per service type
  - **Ordering verification**: Assert infrastructure services (postgresql, redis, rabbitmq) appear before application services in the output
  - **Port uniqueness**: Assert all allocated host ports are unique across all configs
  - **Orchestrator compatibility**: Verify configs have all required fields for `docker.Orchestrator.CreateContainer`

## Test Plan

### Objectives
Validate the complete service-to-container mapping pipeline satisfies all PBI 7 conditions of satisfaction.

### Test Scope
Integration tests covering the full translation pipeline — from `model.Diagram` input to `[]docker.ContainerConfig` output.

### Key Scenarios

1. **Full 5-service diagram translation**
   - Input: Diagram with one of each service type, edges from API→PostgreSQL, API→Redis, Nginx→API
   - Verify: 5 configs returned, correct images, correct ordering, unique ports

2. **Service-specific configuration accuracy**
   - Input: Nodes with populated config JSON (e.g., PostgreSQL version, Redis maxmemory)
   - Verify: Env vars and settings reflect config values

3. **Dependency ordering correctness**
   - Input: Diagram with edges creating clear dependency chain
   - Verify: Infrastructure services precede dependent application services

4. **Port allocation uniqueness**
   - Input: All 5 service types (RabbitMQ with 2 ports)
   - Verify: No duplicate host ports across all configs

5. **Orchestrator contract compliance**
   - Verify: Each config has non-empty Image, non-empty Name, valid port mappings

### Success Criteria
- All tests pass
- Every acceptance criterion is covered by at least one test assertion
- No hardcoded ports conflict

## Verification

- All 5 E2E test functions + 6 subtests pass
- Full backend test suite passes with race detector (`go test -race ./...`)
- `go vet ./...` clean
- Internal AI review: pass (0 critical, 0 high, 0 medium, 4 low deferred)
- All 6 acceptance criteria covered by explicit test assertions

## Files Modified

- `backend/internal/docker/templates/translator_integration_test.go` — NEW: 5 integration tests covering all PBI 7 acceptance criteria
