# [7-1] Container Template Types and Registry

[Back to task list](./tasks.md)

## Description

Define the foundational types for the service-to-container mapping system. This includes the `ContainerTemplate` interface that each service type implements, a `TemplateRegistry` that maps service types to their templates, and named constants for Docker images, default ports, and default environment variables for all 5 service types.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:16:59 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:20:42 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 08:45:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Define a `ContainerTemplate` interface with a method to build a `docker.ContainerConfig` from a `model.DiagramNode`
2. Define a `TemplateRegistry` type that maps `string` (service type) to `ContainerTemplate`
3. Define named constants for all 5 service Docker images:
   - `api-service` → Prism image (e.g., `stoplight/prism:latest`)
   - `postgresql` → `postgres:16`
   - `redis` → `redis:7`
   - `nginx` → `nginx:latest`
   - `rabbitmq` → `rabbitmq:3-management`
4. Define named constants for default container ports (container-side):
   - API Service: 4010 (Prism default)
   - PostgreSQL: 5432
   - Redis: 6379
   - Nginx: 80
   - RabbitMQ: 5672 (AMQP) and 15672 (management UI)
5. Define default environment variable maps where applicable (e.g., PostgreSQL credentials)
6. Place all code in `backend/internal/docker/templates/` package

## Implementation Plan

- Create `backend/internal/docker/templates/types.go` for the interface, registry type, and constants
- The `ContainerTemplate` interface signature: `Build(node model.DiagramNode, hostPort string) (docker.ContainerConfig, error)`
  - Accepts a `hostPort` parameter so port allocation is handled externally
- Export a `NewRegistry()` function that returns a populated `TemplateRegistry` (populated in task 7-2)

## Test Plan

- TypeScript compilation equivalent: verify Go compilation passes with `go build ./...`
- Unit test that `NewRegistry()` returns an empty or stub registry (templates added in 7-2)
- Unit test that all image constants are non-empty strings
- Unit test that all port constants are valid port numbers

## Verification

- All tests pass (`go test ./internal/docker/templates/ -v`)
- `go vet ./...` clean
- `go build ./...` clean
- Internal AI review: pass (0 critical, 0 high, 1 medium resolved, 5 low deferred)
- Medium finding resolved: converted `DefaultPostgresEnv` from mutable exported var to function returning fresh copy

## Files Modified

- `backend/internal/docker/templates/types.go` — NEW: ContainerTemplate interface, TemplateRegistry, image/port constants, DefaultPostgresEnv
- `backend/internal/docker/templates/types_test.go` — NEW: tests for constants, registry, and postgres env
