# [7-2] Service Container Templates

[Back to task list](./tasks.md)

## Description

Implement the 5 service-specific container template builders that convert a `model.DiagramNode` (with its typed config) into a `docker.ContainerConfig`. Each template uses the correct Docker image, applies service-specific environment variables, port mappings, and volume mounts.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:20:42 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:24:37 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 08:45:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **PostgreSQL template** (`postgresql.go`):
   - Image: `postgres:16` (or version from config)
   - Env: `POSTGRES_USER=hephaestus`, `POSTGRES_PASSWORD=hephaestus`, `POSTGRES_DB=hephaestus`
   - Port: 5432 (container side)
   - Hostname derived from node name

2. **Redis template** (`redis.go`):
   - Image: `redis:7`
   - Command args for maxmemory and eviction policy from config (if set)
   - Port: 6379 (container side)

3. **Nginx template** (`nginx.go`):
   - Image: `nginx:latest`
   - Port: 80 (container side)
   - Generate upstream config from `NginxConfig.UpstreamServers` (map to container hostnames on the Docker network)

4. **RabbitMQ template** (`rabbitmq.go`):
   - Image: `rabbitmq:3-management`
   - Env: `RABBITMQ_DEFAULT_VHOST` from config (default `/`)
   - Ports: 5672 (AMQP) and 15672 (management)

5. **API Service template** (`api_service.go`):
   - Image: `stoplight/prism:latest`
   - Port: 4010 (Prism default, container side)
   - Note: OpenAPI spec mounting deferred to PBI 8

6. Register all 5 templates in `NewRegistry()`
7. Parse `node.Config` (json.RawMessage) into the appropriate typed config struct

## Implementation Plan

- Create one file per template in `backend/internal/docker/templates/`
- Each implements the `ContainerTemplate` interface
- Config parsing: unmarshal `node.Config` into the model config struct matching the node type
- Update `NewRegistry()` to register all 5 templates
- Sanitize node names for use as container names (lowercase, replace spaces with hyphens)

## Test Plan

- Unit test each template individually:
  - Provide a `DiagramNode` with realistic config JSON
  - Verify returned `ContainerConfig` has correct Image, Env, Ports, Hostname
- Test config parsing with valid and missing/empty config JSON
- Test that `NewRegistry()` returns a registry with all 5 service types registered
- Test container name sanitization

## Verification

- All 20 tests pass (`go test ./internal/docker/templates/ -v`)
- `go vet ./...` clean
- `go build ./...` clean
- Internal AI review: pass (0 critical, 0 high, 1 medium resolved, 5 low — 2 addressed)
- Medium resolved: added `_ = cfg` with comment explaining PostgreSQL config validation without overridable fields
- Low addressed: replaced manual comma-join with `strings.Join` in nginx template

## Files Modified

- `backend/internal/docker/templates/postgresql.go` — NEW: PostgreSQL template with env defaults and config validation
- `backend/internal/docker/templates/redis.go` — NEW: Redis template with maxmemory/eviction config
- `backend/internal/docker/templates/nginx.go` — NEW: Nginx template with upstream server config
- `backend/internal/docker/templates/rabbitmq.go` — NEW: RabbitMQ template with vhost config and dual ports
- `backend/internal/docker/templates/api_service.go` — NEW: API Service (Prism) template
- `backend/internal/docker/templates/types.go` — MODIFIED: Updated NewRegistry() to register all 5 templates
- `backend/internal/docker/templates/templates_test.go` — NEW: 15 tests for all templates
- `backend/internal/docker/templates/types_test.go` — MODIFIED: Updated registry test to expect 5 entries
