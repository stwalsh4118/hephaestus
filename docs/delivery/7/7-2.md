# [7-2] Service Container Templates

[Back to task list](./tasks.md)

## Description

Implement the 5 service-specific container template builders that convert a `model.DiagramNode` (with its typed config) into a `docker.ContainerConfig`. Each template uses the correct Docker image, applies service-specific environment variables, port mappings, and volume mounts.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. **PostgreSQL template** (`postgresql.go`):
   - Image: `postgres:16` (or version from config)
   - Env: `POSTGRES_USER=hephaestus`, `POSTGRES_PASSWORD=hephaestus`, `POSTGRES_DB=hephaestus`
   - Port: 5432 (container side)
   - Hostname derived from node name

2. **Redis template** (`redis.go`):
   - Image: `redis:7`
   - Command args for maxmemory and eviction policy from config (if set)
   - Port: 6379 (container side)

3. **Nginx template** (`nginx.go`):
   - Image: `nginx:latest`
   - Port: 80 (container side)
   - Generate upstream config from `NginxConfig.UpstreamServers` (map to container hostnames on the Docker network)

4. **RabbitMQ template** (`rabbitmq.go`):
   - Image: `rabbitmq:3-management`
   - Env: `RABBITMQ_DEFAULT_VHOST` from config (default `/`)
   - Ports: 5672 (AMQP) and 15672 (management)

5. **API Service template** (`api_service.go`):
   - Image: `stoplight/prism:latest`
   - Port: 4010 (Prism default, container side)
   - Note: OpenAPI spec mounting deferred to PBI 8

6. Register all 5 templates in `NewRegistry()`
7. Parse `node.Config` (json.RawMessage) into the appropriate typed config struct

## Implementation Plan

- Create one file per template in `backend/internal/docker/templates/`
- Each implements the `ContainerTemplate` interface
- Config parsing: unmarshal `node.Config` into the model config struct matching the node type
- Update `NewRegistry()` to register all 5 templates
- Sanitize node names for use as container names (lowercase, replace spaces with hyphens)

## Test Plan

- Unit test each template individually:
  - Provide a `DiagramNode` with realistic config JSON
  - Verify returned `ContainerConfig` has correct Image, Env, Ports, Hostname
- Test config parsing with valid and missing/empty config JSON
- Test that `NewRegistry()` returns a registry with all 5 service types registered
- Test container name sanitization

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
