# [7-4] Dependency Resolver

[Back to task list](./tasks.md)

## Description

Implement a dependency resolver that determines container startup order from diagram edges and service types. Databases and caches should start before services that depend on them. The resolver performs topological sorting with cycle detection.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Accept a list of `model.DiagramNode` and `model.DiagramEdge` as input
2. Build a directed dependency graph from edges (edge source depends on edge target, i.e., if A→B, then B should start before A)
3. Apply service-type priority: infrastructure services (postgresql, redis, rabbitmq) start before application services (nginx, api-service)
4. Produce a topologically sorted list of node IDs representing startup order
5. Detect cycles and return an error if the dependency graph has circular dependencies
6. Nodes with no dependencies start first (respecting type priority)

## Implementation Plan

- Create `backend/internal/docker/templates/dependency.go`
- Define service type priority levels as constants:
  - Priority 0 (highest / start first): postgresql, redis, rabbitmq
  - Priority 1: nginx, api-service
- `ResolveDependencies(nodes []model.DiagramNode, edges []model.DiagramEdge) ([]string, error)`
  - Returns ordered list of node IDs
- Algorithm: Kahn's algorithm (BFS topological sort)
  - Build adjacency list and in-degree map from edges
  - Seed queue with zero in-degree nodes, sorted by service type priority
  - Process queue, maintaining priority ordering for ties
- Return error on cycle detection (remaining nodes with non-zero in-degree after BFS completes)

## Test Plan

- Unit test: linear dependency chain produces correct order
- Unit test: diamond dependency graph resolves correctly
- Unit test: nodes with no edges ordered by service type priority
- Unit test: mixed — some edges plus type priority for independent nodes
- Unit test: single node returns that node
- Unit test: cycle detection returns error
- Unit test: empty input returns empty result

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
