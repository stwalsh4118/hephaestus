# [7-3] Port Allocator

[Back to task list](./tasks.md)

## Description

Implement a port allocator that assigns unique host ports to containers, avoiding conflicts. The allocator tracks used ports within a deployment session and assigns from a configurable range.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:24:37 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:27:43 | Status Change | InProgress | Review | Implementation complete, internal AI review passed after fix | AI_Agent |

## Requirements

1. Allocate unique host ports from a defined range (e.g., 10000–19999)
2. Track allocated ports to prevent conflicts within a deployment
3. Support allocating multiple ports for a single service (e.g., RabbitMQ needs 2 ports)
4. Provide a `Reset()` method to clear allocations for a new deployment
5. Return an error if the port range is exhausted
6. Thread-safe for concurrent use

## Implementation Plan

- Create `backend/internal/docker/templates/port_allocator.go`
- `PortAllocator` struct with:
  - `minPort`, `maxPort` range bounds
  - `usedPorts` set (map[string]bool)
  - `nextPort` cursor for sequential allocation
  - `sync.Mutex` for thread safety
- `NewPortAllocator(minPort, maxPort int) *PortAllocator`
- `Allocate() (string, error)` — returns next available port as string
- `AllocateN(n int) ([]string, error)` — allocates N consecutive-available ports
- `Reset()` — clears all allocations

## Test Plan

- Unit test sequential allocation returns unique ports
- Unit test `AllocateN` returns correct number of ports, all unique
- Unit test `Reset` allows reuse of previously allocated ports
- Unit test exhaustion returns an error
- Unit test thread safety with concurrent allocations

## Verification

- All 7 tests pass (`go test -race ./internal/docker/templates/ -run PortAllocator`)
- `go vet ./...` clean
- Race detector: clean
- Internal AI review: initially blocked on non-atomic AllocateN — fixed with lock-held batch allocation and rollback on failure. Re-review: pass.
- Used `strconv.Itoa` instead of `fmt.Sprintf` per review suggestion

## Files Modified

- `backend/internal/docker/templates/port_allocator.go` — NEW: PortAllocator with Allocate, AllocateN (atomic with rollback), Reset
- `backend/internal/docker/templates/port_allocator_test.go` — NEW: 7 tests including concurrent safety and rollback verification
