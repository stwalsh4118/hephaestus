# [7-5] Diagram-to-Container Translator

[Back to task list](./tasks.md)

## Description

Implement the top-level translator that takes a `model.Diagram` and produces an ordered slice of `docker.ContainerConfig` ready for the orchestration engine. This ties together the template registry, port allocator, and dependency resolver.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:11:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:30:47 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:33:47 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 08:45:58 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Accept a `model.Diagram` as input
2. Validate all nodes have a supported service type (return error for unknown types)
3. Resolve startup order using the dependency resolver
4. Allocate host ports using the port allocator
5. Build `docker.ContainerConfig` for each node using the template registry (in dependency order)
6. Return the ordered slice of `ContainerConfig` values
7. Handle multi-port services (e.g., RabbitMQ) correctly

## Implementation Plan

- Create `backend/internal/docker/templates/translator.go`
- `Translator` struct with:
  - `registry TemplateRegistry`
  - `allocator *PortAllocator`
- `NewTranslator() *Translator` — constructs with default registry and port allocator
- `Translate(diagram model.Diagram) ([]docker.ContainerConfig, error)`:
  1. Validate node types against registry
  2. Call `ResolveDependencies(diagram.Nodes, diagram.Edges)`
  3. Reset port allocator for fresh deployment
  4. For each node ID in order: look up template, allocate port(s), call `Build()`
  5. Return ordered configs
- Expose for use by future PBI-9 (Deploy Flow)

## Test Plan

- Unit test: translate a diagram with all 5 service types, verify 5 configs returned in dependency order
- Unit test: diagram with unknown service type returns validation error
- Unit test: empty diagram returns empty result
- Unit test: single-node diagram produces one config
- Unit test: verify port allocator is reset per translation call
- Unit test: verify configs have correct NetworkName set

## Verification

- All 6 translator tests pass
- Full backend test suite passes (`go test ./...`)
- `go vet ./...` clean
- `go build ./...` clean
- Internal AI review: pass (0 critical, 0 high, 0 medium, 5 low — 1 addressed: concurrency doc comment)

## Files Modified

- `backend/internal/docker/templates/translator.go` — NEW: Translator struct, NewTranslator, Translate method, portsRequired helper
- `backend/internal/docker/templates/translator_test.go` — NEW: 6 tests for all service types, validation, empty, single node, port reset, RabbitMQ dual ports
