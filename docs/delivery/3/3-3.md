# [3-3] Extend Store with Node Selection & Config

[Back to task list](./tasks.md)

## Description

Extend the Zustand canvas store to track the currently selected node and support updating node configuration data. This provides the state backbone for the config panel (task 3-4) and config forms (tasks 3-5, 3-6).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 09:47:52 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 10:03:10 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 10:06:16 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. Add `selectedNodeId: string | null` to store state
2. Add `selectNode(nodeId: string | null): void` action
3. Add `updateNodeConfig(nodeId: string, config: ServiceConfig): void` action that merges config into the node's `data.config`
4. When a node is deleted, if it was selected, clear `selectedNodeId`
5. Provide a derived selector `useSelectedNode()` that returns the full node object or null

## Implementation Plan

1. Update `frontend/src/store/canvas-store.ts`:
   - Add `selectedNodeId` to initial state (default `null`)
   - Add `selectNode` action
   - Add `updateNodeConfig` action — finds node by ID, shallow-merges config into `data.config`, produces new nodes array
   - Wrap `onNodesChange` to detect node removal and clear selection if needed
2. Add `useSelectedNode` derived selector (either in store file or as a custom hook)
3. Wire `selectNode` into `DiagramCanvas.tsx` via `onNodeClick` and `onPaneClick` (deselect)

## Test Plan

- `selectNode("node-1")` sets `selectedNodeId` to `"node-1"`
- `selectNode(null)` clears selection
- `updateNodeConfig` updates the correct node's config without mutating other nodes
- Deleting a selected node clears `selectedNodeId`
- `useSelectedNode` returns the correct node object

## Verification

- TypeScript compilation: PASS
- ESLint: PASS
- Prettier: PASS
- E2E tests: PASS
- Internal AI review: PASS (0 critical, 0 high, 2 medium — both addressed, 5 low — deferred)
- Note: updateNodeConfig does full config replacement (not merge) since ServiceConfig is a discriminated union where partial merge is not type-safe

## Files Modified

- `frontend/src/store/canvas-store.ts` — Added selectedNodeId, selectNode, updateNodeConfig, useSelectedNode; enhanced onNodesChange for selection clearing
- `frontend/src/components/canvas/DiagramCanvas.tsx` — Added onNodeClick and onPaneClick handlers for selection
