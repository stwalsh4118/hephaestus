# [9-2] Deploy REST Endpoints

[Back to task list](./tasks.md)

## Description

Add the three deploy REST endpoints (`POST /api/deploy`, `DELETE /api/deploy`, `GET /api/deploy/status`) to the backend. Create a `DeployHandler` that calls the `DeploymentManager` from task 9-1 and returns appropriate JSON responses.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:04:21 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. `POST /api/deploy`:
   - Accepts diagram JSON body (same schema as `POST /api/diagrams`)
   - Calls `DeploymentManager.Deploy(ctx, diagram)`
   - Returns `202 Accepted` with `{ "status": "deploying" }` on success
   - Returns `400 Bad Request` on invalid diagram
   - Returns `409 Conflict` if already deploying
2. `DELETE /api/deploy`:
   - Calls `DeploymentManager.Teardown(ctx)`
   - Returns `200 OK` with `{ "status": "idle" }`
   - Returns `409 Conflict` if not currently deployed
3. `GET /api/deploy/status`:
   - Calls `DeploymentManager.GetStatus(ctx)`
   - Returns `200 OK` with `{ "deployStatus": "...", "nodeStatuses": [...] }`
4. Register all routes in `main.go` following existing handler registration pattern
5. Follow existing response patterns (`writeJSON`, `writeError` from `response.go`)
6. Update `docs/api-specs/backend/backend-api.md` with the new endpoints

## Implementation Plan

- Create `backend/internal/handler/deploy.go` — `DeployHandler` struct with `ServeHTTP` or individual methods
- Register routes in `backend/cmd/server/main.go`: `POST /api/deploy`, `DELETE /api/deploy`, `GET /api/deploy/status`
- Pass `DeploymentManager` as dependency to handler
- Update backend API spec with new endpoint documentation

## Test Plan

- **Unit tests** using `httptest`:
  - `POST /api/deploy` with valid diagram → 202
  - `POST /api/deploy` with invalid body → 400
  - `POST /api/deploy` while already deploying → 409
  - `DELETE /api/deploy` while deployed → 200
  - `DELETE /api/deploy` while idle → 409
  - `GET /api/deploy/status` → 200 with correct status structure
- Mock `DeploymentManager` for handler tests

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
