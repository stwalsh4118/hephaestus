# [9-4] Frontend API Client & Deploy Store

[Back to task list](./tasks.md)

## Description

Create the frontend infrastructure for the deploy flow: API client functions for the deploy endpoints, a WebSocket client for real-time status updates, and a Zustand deploy store that manages deployment state and per-node container statuses.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:04:21 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 08:37:10 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 08:39:03 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 16:08:41 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **API Client** (`frontend/src/lib/deploy-api.ts`):
   - `deployDiagram(diagram: DiagramJson): Promise<{ status: string }>` — POST /api/deploy
   - `teardownDiagram(): Promise<{ status: string }>` — DELETE /api/deploy
   - `getDeployStatus(): Promise<DeployStatusResponse>` — GET /api/deploy/status
   - Use `fetch` (no external HTTP library needed)
   - Handle HTTP errors, return typed responses
2. **WebSocket Client** (`frontend/src/lib/ws-client.ts`):
   - `connectStatusWs(onMessage: (msg: StatusMessage) => void): WebSocket` — connects to `ws://localhost:8080/ws/status`
   - Handle open, close, error, reconnection (simple retry with backoff)
   - Parse incoming JSON messages into `StatusMessage` type
   - Provide `disconnectStatusWs()` for cleanup
3. **Deploy Store** (`frontend/src/store/deploy-store.ts`):
   - State:
     - `deployStatus: 'idle' | 'deploying' | 'deployed' | 'tearing_down' | 'error'`
     - `nodeStatuses: Map<string, ContainerStatus>` (keyed by canvas node ID)
     - `error: string | null`
   - Actions:
     - `deploy(diagram: DiagramJson)` — calls API, sets status to deploying, connects WebSocket
     - `teardown()` — calls API, disconnects WebSocket, resets state
     - `updateFromStatusMessage(msg: StatusMessage)` — updates nodeStatuses and deployStatus from WS message
     - `reset()` — clear all state
4. **Types** (`frontend/src/types/deploy.ts`):
   - `DeployStatus`, `ContainerStatus`, `NodeStatus`, `StatusMessage`, `DeployStatusResponse`
   - Must match backend message format

## Implementation Plan

- Create `frontend/src/types/deploy.ts` — shared deploy types
- Create `frontend/src/lib/deploy-api.ts` — fetch-based API client
- Create `frontend/src/lib/ws-client.ts` — WebSocket client with reconnection
- Create `frontend/src/store/deploy-store.ts` — Zustand store
- Backend URL: use environment variable or default `http://localhost:8080`

## Test Plan

- **Unit tests** for deploy store:
  - `deploy()` sets status to `deploying`
  - `updateFromStatusMessage()` correctly populates `nodeStatuses` map
  - `teardown()` resets state to idle
  - `reset()` clears everything
- **Unit tests** for API client:
  - Mock fetch — verify correct URL, method, body for each endpoint
  - Error responses throw with message

## Verification

- TypeScript compilation: pass (tsc --noEmit)
- ESLint: pass (pnpm lint)
- AI review: pass (0 critical, 0 high)

## Files Modified

- `frontend/src/types/deploy.ts` — New: DeployStatus, ContainerStatus, NodeStatus, StatusMessage, DeployResponse, DeployStatusResponse types
- `frontend/src/lib/deploy-api.ts` — New: deployDiagram, teardownDiagram, getDeployStatus, updateDeploy fetch wrappers
- `frontend/src/lib/ws-client.ts` — New: connectStatusWs, disconnectStatusWs WebSocket client with reconnection
- `frontend/src/store/deploy-store.ts` — New: Zustand deploy store with deploy, teardown, updateFromStatusMessage, reset actions
