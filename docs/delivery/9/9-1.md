# [9-1] Deploy Service — Types, State Tracker & Core Logic

[Back to task list](./tasks.md)

## Description

Define the types, interfaces, and core service logic for the deploy flow. The `DeploymentManager` is the central coordinator that translates a diagram into running containers, tracks the mapping between diagram nodes and container IDs, supports teardown, status queries, and computes diffs for incremental updates.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:04:21 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 08:21:59 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 08:29:25 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 16:08:41 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Define deploy-specific types in a new `backend/internal/deploy/` package:
   - `DeployRequest` — wraps a `model.Diagram` for deployment
   - `DeployStatus` — overall deployment state (`idle`, `deploying`, `deployed`, `tearing_down`, `error`)
   - `NodeStatus` — per-node status combining node ID, container ID, and `docker.ContainerStatus`
   - `StatusMessage` — WebSocket message format: `{ type: "status_update", nodeStatuses: []NodeStatus, deployStatus: DeployStatus }`
2. Implement `DeploymentManager` struct with:
   - `Deploy(ctx, diagram)` — uses existing `Translator` to generate `ContainerConfig` list, calls `Orchestrator.CreateNetwork`, then creates and starts containers in dependency order, tracks node-to-container mapping
   - `Teardown(ctx)` — calls `Orchestrator.TeardownAll`, clears tracked state
   - `GetStatus(ctx)` — returns current `DeployStatus` and slice of `NodeStatus` for all tracked containers
   - `ComputeDiff(currentDiagram, newDiagram)` — returns added/removed/unchanged node lists
   - `ApplyDiff(ctx, added, removed)` — deploys new containers, removes old ones without touching unchanged
3. `DeploymentManager` must be safe for concurrent access (mutex-protected state)
4. Reuse existing `templates.Translator` and `docker.Orchestrator` — no duplication
5. Map diagram node IDs to container IDs so the frontend can correlate status updates with canvas nodes

## Implementation Plan

- Create `backend/internal/deploy/` package
- `types.go` — all type definitions (DeployRequest, DeployStatus, NodeStatus, StatusMessage, etc.)
- `manager.go` — DeploymentManager implementation
- `diff.go` — ComputeDiff logic (compare node sets by ID, detect additions/removals)
- Constructor: `NewDeploymentManager(orchestrator docker.Orchestrator, translator *templates.Translator) *DeploymentManager`

## Test Plan

- **Unit tests** for `ComputeDiff`:
  - Empty → nodes added = all new
  - Nodes → empty = all removed
  - Mix of added, removed, unchanged
  - Node with same ID but modified config counts as unchanged (config changes are not diff-tracked in this task)
- **Unit tests** for `Deploy`:
  - Mock orchestrator and translator
  - Verify create/start called in correct order
  - Verify node-to-container mapping populated
  - Verify state transitions (idle → deploying → deployed)
- **Unit tests** for `Teardown`:
  - Verify TeardownAll called on orchestrator
  - Verify state cleared (idle, empty map)
- **Unit tests** for `ApplyDiff`:
  - Added nodes get new containers created/started
  - Removed nodes get containers stopped/removed
  - Unchanged nodes untouched

## Verification

- Go tests: pass (`go test -race ./...` — all pass)
- Go vet: pass (implicit in test run)
- AI review: pass (0 critical, 0 high)

## Files Modified

- `backend/internal/deploy/types.go` — New: DeployStatus, NodeStatus, StatusMessage, Diff types and constants
- `backend/internal/deploy/manager.go` — New: DeploymentManager with Deploy, Teardown, GetStatus, ApplyDiff, BuildStatusMessage
- `backend/internal/deploy/manager_test.go` — New: Unit tests for Deploy, Teardown, GetStatus, ApplyDiff
- `backend/internal/deploy/diff.go` — New: ComputeDiff logic for node set comparison
- `backend/internal/deploy/diff_test.go` — New: Unit tests for ComputeDiff
- `backend/internal/deploy/bridge.go` — New: BuildStatusMessage helper for container→node status conversion
- `backend/internal/deploy/bridge_test.go` — New: Unit tests for BuildStatusMessage
