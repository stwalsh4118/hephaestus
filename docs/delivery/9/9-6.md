# [9-6] Live Topology Updates

[Back to task list](./tasks.md)

## Description

Enable live topology updates so that adding or removing nodes from a deployed diagram applies changes incrementally without full teardown. The frontend detects diagram changes while deployed and sends updated topology to the backend, which diffs and applies only the changes.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:04:21 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 08:46:38 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 08:53:33 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 16:08:41 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Backend — Incremental Deploy Endpoint**:
   - `PUT /api/deploy` — accepts updated diagram JSON
   - Calls `DeploymentManager.ComputeDiff` then `ApplyDiff`
   - Returns `200 OK` with updated status
   - Returns `409 Conflict` if not currently deployed
2. **Frontend — Change Detection**:
   - When deployed and the user adds a node → auto-trigger or provide a "Re-deploy" / "Update" button
   - When deployed and the user removes a node → same trigger
   - Design choice: explicit "Update Deploy" button (appears when diagram differs from deployed state) rather than auto-deploy, to give user control
3. **Frontend — Update Deploy Button**:
   - Appears in toolbar only when deployed AND diagram has changed since last deploy
   - Calls `PUT /api/deploy` with current diagram
   - Track "last deployed diagram" snapshot in deploy store for comparison
4. **Diff Detection Logic** (frontend):
   - Compare current node IDs vs last-deployed node IDs
   - Simple set comparison — new IDs = added, missing IDs = removed
5. Update API spec with the PUT endpoint

## Implementation Plan

- Add `PUT /api/deploy` handler in `backend/internal/handler/deploy.go`
- Register route in `main.go`
- Add `lastDeployedDiagram` to deploy store
- Add `hasChanges` derived state (compare current vs last deployed)
- Add "Update Deploy" button in toolbar (visible only when `hasChanges && deployStatus === 'deployed'`)
- Update `docs/api-specs/backend/backend-api.md`

## Test Plan

- **Backend unit tests**:
  - `PUT /api/deploy` with added node → only new container created
  - `PUT /api/deploy` with removed node → only that container removed
  - `PUT /api/deploy` when not deployed → 409
- **Frontend unit tests**:
  - `hasChanges` returns true when node added after deploy
  - `hasChanges` returns false when diagram matches last deployed
- **Integration** (covered by E2E task):
  - Deploy → add node → update → verify only new container started

## Verification

- Go tests: pass (`go test -race ./...` — all pass including 3 new PUT handler tests)
- Go vet: pass
- TypeScript compilation: pass (tsc --noEmit)
- ESLint: pass (pnpm lint)
- AI review: pass (0 critical, 0 high)

## Files Modified

- `backend/internal/handler/deploy.go` — Added `PUT /api/deploy` route and `Update` handler
- `backend/internal/handler/deploy_test.go` — Added 3 tests: Update_AddedNode, Update_RemovedNode, Update_NotDeployed
- `frontend/src/store/deploy-store.ts` — Added `updateDeploy` action and `isUpdating` guard
- `frontend/src/lib/diagram-diff.ts` — New: extracted `hasDiagramChanges` pure function
- `frontend/src/components/canvas/DiagramWorkspace.tsx` — Added "Update Deploy" button with `hasChanges` logic
- `docs/api-specs/backend/backend-api.md` — Added PUT /api/deploy endpoint documentation
