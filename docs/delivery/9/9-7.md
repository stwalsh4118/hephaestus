# [9-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI 9 acceptance criteria. Tests the complete deploy flow from frontend through backend to Docker containers, including real-time status, live updates, and teardown.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:04:21 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all 7 acceptance criteria from the PBI:

1. **AC1**: Deploy button sends the current diagram topology to `POST /api/deploy`
2. **AC2**: Backend creates containers for all nodes and reports progress
3. **AC3**: Real-time container status updates appear on canvas nodes via WebSocket
4. **AC4**: Adding a new node to a deployed diagram deploys only the new container (no full teardown)
5. **AC5**: Removing a node from a deployed diagram removes only that container
6. **AC6**: Teardown button removes all containers and resets status indicators
7. **AC7**: Container errors are surfaced in the UI with actionable messages

## Implementation Plan

### Test Environment
- Backend running with Docker access
- Frontend dev server running
- Playwright for browser-based verification

### Test Scenarios

**Scenario 1: Full Deploy Flow (AC1, AC2, AC3)**
1. Create a diagram with 2-3 nodes (e.g., API + PostgreSQL + Redis)
2. Click Deploy button
3. Verify POST /api/deploy called with diagram JSON
4. Verify containers created (check via `GET /api/deploy/status`)
5. Verify WebSocket sends status updates
6. Verify canvas nodes show green (running) status badges

**Scenario 2: Live Add Node (AC4)**
1. With deployed diagram, add a new node (e.g., Nginx)
2. Click Update Deploy
3. Verify only the new container is created (existing containers unchanged)
4. Verify new node gets status badge

**Scenario 3: Live Remove Node (AC5)**
1. With deployed diagram, remove a node
2. Click Update Deploy
3. Verify only that container is removed (others unchanged)
4. Verify removed node's status badge disappears

**Scenario 4: Full Teardown (AC6)**
1. With deployed diagram, click Teardown
2. Verify all containers stopped and removed
3. Verify all status badges reset to grey/hidden
4. Verify deploy status returns to idle

**Scenario 5: Error Handling (AC7)**
1. Deploy a diagram that will cause a container error (e.g., invalid config)
2. Verify error status appears on the affected node
3. Verify error message displayed in UI (toast/banner)

## Test Plan

### Objectives
Validate the complete deploy flow end-to-end against all PBI 9 Conditions of Satisfaction.

### Test Scope
- Backend deploy endpoints (POST, PUT, DELETE, GET)
- WebSocket status broadcasting
- Frontend deploy UI (buttons, status badges, error feedback)
- Docker container lifecycle (create, start, stop, remove)
- Incremental deploy (add/remove nodes)

### Environment & Setup
- Docker daemon running and accessible
- Backend started with `go run ./cmd/server`
- Frontend started with `pnpm dev`
- Playwright browser automation

### Success Criteria
- All 5 scenarios pass
- All 7 acceptance criteria verified
- No orphaned containers after teardown
- WebSocket reconnects gracefully if backend restarts

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
