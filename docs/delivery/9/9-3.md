# [9-3] WebSocket Status Hub & Broadcasting

[Back to task list](./tasks.md)

## Description

Enhance the existing WebSocket scaffolding at `/ws/status` to support multi-client broadcasting of container status updates. Create a hub that manages connected clients and broadcasts status messages from the orchestrator's health polling callback.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:04:21 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Implement a `StatusHub` (or extend existing WebSocket handler) that:
   - Tracks connected WebSocket clients (register/unregister on connect/disconnect)
   - Provides a `Broadcast(message)` method to send a JSON message to all connected clients
   - Handles client disconnections gracefully (remove from set, don't block broadcast)
2. Integrate with `Orchestrator.StartHealthPolling`:
   - When deployment starts, begin health polling with a callback that:
     - Converts `map[string]ContainerStatus` (keyed by container ID) to `StatusMessage` (keyed by node ID, using the DeploymentManager's mapping)
     - Calls `StatusHub.Broadcast(statusMessage)` to push to all clients
   - When teardown completes, stop polling and broadcast final "idle" status
3. WebSocket message format (JSON):
   ```json
   {
     "type": "status_update",
     "deployStatus": "deployed",
     "nodeStatuses": [
       { "nodeId": "abc", "containerId": "xyz", "status": "running" }
     ]
   }
   ```
4. Maintain existing ping/pong keep-alive behavior
5. Hub must be safe for concurrent access

## Implementation Plan

- Create `backend/internal/handler/status_hub.go` — `StatusHub` struct with `Register`, `Unregister`, `Broadcast`, `Run` methods (goroutine-based hub pattern)
- Update `backend/internal/handler/websocket.go` — register clients with hub on connect, unregister on disconnect
- Create bridge function in `backend/internal/deploy/` that converts health poll results to `StatusMessage` using node-to-container mapping
- Wire hub into `main.go` — start hub goroutine, pass to WebSocket handler and DeploymentManager

## Test Plan

- **Unit tests** for `StatusHub`:
  - Register client → broadcast → client receives message
  - Unregister client → broadcast → no error, client doesn't receive
  - Multiple clients → broadcast → all receive
  - Client disconnect → unregistered automatically
- **Unit tests** for status message conversion:
  - Container ID map → node ID map using deployment tracking
  - Missing container ID handled gracefully

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
