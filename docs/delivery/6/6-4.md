# [6-4] Container Lifecycle Management

[Back to task list](./tasks.md)

## Description

Implement the core container lifecycle operations: creating containers from images with configuration, starting, stopping, removing, listing, and inspecting containers. Containers join the shared network with their service name as hostname.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 06:18:07 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. `CreateContainer(ctx, config)` must:
   - Pull image if not present locally (with timeout)
   - Create container with: image, environment variables, port bindings, volume mounts
   - Apply `heph-` name prefix to container name
   - Connect container to the shared network with hostname set to the service name
   - Return the container ID
2. `StartContainer(ctx, containerID)` starts a created container
3. `StopContainer(ctx, containerID)` stops a running container with a graceful timeout
4. `RemoveContainer(ctx, containerID)` removes a stopped container (force-remove if still running)
5. `ListContainers(ctx)` lists all containers with the `heph-` prefix, returning `[]ContainerInfo`
6. `InspectContainer(ctx, containerID)` returns detailed `ContainerInfo` for a single container
7. Track managed container IDs internally for teardown
8. Handle Docker API errors with meaningful wrapped errors

## Implementation Plan

1. Add container lifecycle methods to `DockerOrchestrator` in `backend/internal/docker/engine.go`
2. `CreateContainer`: use `client.ImagePull` → `client.ContainerCreate` with `container.Config`, `container.HostConfig`, `network.NetworkingConfig` → `client.NetworkConnect`
3. `StartContainer`: use `client.ContainerStart`
4. `StopContainer`: use `client.ContainerStop` with graceful timeout (10s default, constant)
5. `RemoveContainer`: use `client.ContainerRemove` with force option
6. `ListContainers`: use `client.ContainerList` with name filter prefix `heph-`
7. `InspectContainer`: use `client.ContainerInspect`, map to `ContainerInfo`
8. Maintain `managedContainers map[string]string` (ID → name) on the orchestrator struct
9. Map Docker container states to `ContainerStatus` enum

## Test Plan

### Objectives
Verify each container lifecycle operation works correctly in isolation.

### Mocking Strategy
Mock the Docker client interface to test orchestrator logic without requiring Docker daemon.

### Key Scenarios
- **Create**: Verify image pull is attempted, container config is correct, name prefix applied, network connection made
- **Start**: Verify `ContainerStart` is called with correct ID
- **Stop**: Verify graceful timeout is passed to `ContainerStop`
- **Remove**: Verify force flag is set
- **List**: Verify filter uses correct prefix, response maps to `ContainerInfo` correctly
- **Inspect**: Verify status mapping from Docker states to `ContainerStatus`
- **Error handling**: Docker API errors are wrapped with context

### Success Criteria
- All operations call Docker API with correct parameters
- Managed container tracking is updated on create/remove
- Docker state mapping is accurate

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
