# [6-6] Teardown & Graceful Cleanup

[Back to task list](./tasks.md)

## Description

Implement full teardown that removes all managed containers and the shared network. Wire the teardown into the server's graceful shutdown sequence so that containers are cleaned up when the backend exits.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 06:18:07 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 07:13:07 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 07:17:04 | Status Change | InProgress | Review | Implementation complete, internal AI review passed after fixes | AI_Agent |
| 2026-02-19 07:32:50 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. `TeardownAll(ctx)` must:
   - Stop all managed containers (with graceful timeout)
   - Remove all managed containers
   - Remove the shared Docker network
   - Clear internal tracking state
   - Be idempotent — safe to call multiple times
2. Handle partially-failed teardowns: continue removing remaining containers even if one fails
3. Collect and return all errors encountered during teardown
4. Wire `TeardownAll` into `cmd/server/main.go` graceful shutdown sequence (after HTTP server shutdown, before exit)
5. Ensure health polling is stopped before teardown begins (cancel context)

## Implementation Plan

1. Implement `TeardownAll` on `DockerOrchestrator`:
   - Iterate managed containers: stop then remove each
   - Call `RemoveNetwork` after all containers removed
   - Use `errors.Join` or similar to collect multiple errors
   - Clear `managedContainers` map
2. Update `cmd/server/main.go`:
   - Initialize `DockerOrchestrator` in main (alongside existing services)
   - Add `orchestrator.TeardownAll(ctx)` to the shutdown sequence
   - Log teardown results
3. Ensure teardown respects the shutdown timeout

## Test Plan

- Unit test: `TeardownAll` stops and removes all tracked containers then removes network (mock Docker client)
- Unit test: `TeardownAll` continues even if one container removal fails
- Unit test: `TeardownAll` is idempotent — second call with empty tracking is a no-op
- Unit test: errors from multiple failed removals are all collected and returned
- Integration: full teardown with real Docker tested in 6-7

## Verification

- `go build ./...` compiles without errors
- All 33 tests pass with `-race` flag
- `go vet ./...` passes
- `golangci-lint run ./...` reports 0 issues
- Internal AI review: pass (after fixing networkID thread safety and adding pollingCtx pattern)

## Files Modified

- `backend/internal/docker/engine.go` — TeardownAll implementation with proper locking
- `backend/cmd/server/main.go` — Docker orchestrator init, pollingCtx, teardown in shutdown sequence
- `backend/internal/docker/engine_test.go` — 4 new teardown tests
