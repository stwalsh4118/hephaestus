# [6-5] Health Check & Status Reporting

[Back to task list](./tasks.md)

## Description

Implement periodic health check polling that inspects container states via the Docker API and reports accurate container status (running, stopped, error, healthy, unhealthy).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 06:18:07 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 07:09:26 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 07:12:39 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. `HealthCheck(ctx, containerID)` inspects a single container and returns its `ContainerStatus`
2. Map Docker container states accurately:
   - `created` → `StatusCreated`
   - `running` + no healthcheck or healthcheck passing → `StatusHealthy` (or `StatusRunning` if no healthcheck defined)
   - `running` + healthcheck failing → `StatusUnhealthy`
   - `exited` / `dead` → `StatusStopped`
   - Other error states → `StatusError`
3. Implement a `StartHealthPolling(ctx, interval, callback)` method:
   - Runs in a background goroutine
   - Polls all managed containers at the specified interval
   - Calls the callback with updated status map `map[string]ContainerStatus`
   - Stops when context is cancelled
4. Handle containers that disappear between polls gracefully
5. Use named constant for default polling interval (e.g., `DefaultHealthCheckInterval = 5 * time.Second`)

## Implementation Plan

1. Implement `HealthCheck` method on `DockerOrchestrator` using `client.ContainerInspect`
2. Create status mapping function `mapDockerState(state *types.ContainerState) ContainerStatus`
3. Implement `StartHealthPolling` using `time.NewTicker` and a goroutine
4. Callback receives `map[string]ContainerStatus` keyed by container ID
5. Handle `container not found` errors by reporting `StatusError` and removing from tracking

## Test Plan

- Unit test: `mapDockerState` correctly maps all Docker states to `ContainerStatus`
- Unit test: `HealthCheck` returns correct status for various container states (mock Docker client)
- Unit test: `HealthCheck` handles "container not found" gracefully
- Unit test: `StartHealthPolling` calls callback at intervals and stops on context cancellation
- Integration: real Docker health checks tested in 6-7

## Verification

- `go build ./...` compiles without errors
- All 29 tests pass with `-race` flag
- `go vet ./...` passes
- `golangci-lint run ./...` reports 0 issues
- Internal AI review: pass

## Files Modified

- `backend/internal/docker/engine.go` — HealthCheck method, StartHealthPolling method
- `backend/internal/docker/types.go` — DefaultHealthCheckInterval constant, HealthStatusCallback type
- `backend/internal/docker/engine_test.go` — 6 new tests for health check and polling
