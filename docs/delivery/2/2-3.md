# [2-3] Create Zustand Canvas State Store

[Back to task list](./tasks.md)

## Description

Implement a Zustand store that manages the canvas state: nodes, edges, and viewport. This store serves as the single source of truth for all canvas data, ensuring state persists across re-renders and is accessible by all canvas-related components.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 07:33:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 07:46:33 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 07:48:47 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 08:53:11 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create a Zustand store with the following state:
   - `nodes`: Array of React Flow nodes (typed with `CanvasNodeData`)
   - `edges`: Array of React Flow edges
   - `viewport`: Current React Flow viewport (`x`, `y`, `zoom`)
2. Implement the following actions:
   - `onNodesChange`: Handler for React Flow's `onNodesChange` callback (handles drag, select, remove)
   - `onEdgesChange`: Handler for React Flow's `onEdgesChange` callback
   - `onViewportChange`: Handler for React Flow viewport updates
   - `addNode`: Add a new node at a given position with given data
3. Store must use React Flow's `applyNodeChanges` and `applyEdgeChanges` helpers for change handling
4. State must persist during the session (not lost on component re-render)
5. Store file located at `frontend/src/store/canvas-store.ts`

## Implementation Plan

1. Create `frontend/src/store/canvas-store.ts`
2. Define the store interface (`CanvasStore`) using types from task 2-2
3. Implement the store using `zustand`'s `create` function
4. Use `applyNodeChanges` / `applyEdgeChanges` from `@xyflow/react` in change handlers
5. Implement `addNode` action that creates a properly typed React Flow node

**Dependencies**: Task 2-2 (types and constants must exist)

## Test Plan

- TypeScript compilation passes without errors
- Unit test: store initializes with empty nodes/edges arrays
- Unit test: `addNode` adds a node to the store's nodes array with correct structure
- Unit test: `onNodesChange` applies position changes correctly

## Verification

- Added `frontend/src/store/canvas-store.ts` with a typed Zustand store containing:
  - `nodes` and `edges` state arrays
  - `viewport` state with default values
  - `onNodesChange` implemented with `applyNodeChanges`
  - `onEdgesChange` implemented with `applyEdgeChanges`
  - `onViewportChange` to keep viewport state in sync
  - `addNode` action that appends a new typed node at a provided position
- Verified session persistence behavior by storing state in module-level Zustand store (`useCanvasStore`), which survives component re-renders.
- Ran `pnpm test` (`tsc --noEmit`) in `frontend/`; type check passed.
- Internal AI review verdict: `pass`.

## Files Modified

- `frontend/src/store/canvas-store.ts`
- `docs/delivery/2/2-3.md`
- `docs/delivery/2/tasks.md`
