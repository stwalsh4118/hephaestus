# [2-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

Verify all PBI-2 Conditions of Satisfaction end-to-end. This task validates the complete user workflow: canvas rendering, palette interaction, drag-and-drop node creation, node repositioning, zoom/pan, and state persistence during the session.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 07:33:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 08:11:54 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 08:34:14 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 08:55:22 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify each PBI-2 acceptance criterion:

1. **AC1**: React Flow canvas renders in the main viewport
2. **AC2**: A sidebar palette displays draggable component items
3. **AC3**: Dragging an item from the palette onto the canvas creates a new node
4. **AC4**: Nodes can be repositioned by dragging on the canvas
5. **AC5**: Canvas supports zoom (scroll wheel) and pan (background drag)
6. **AC6**: Canvas state (nodes and positions) persists during the session (not lost on re-render)

## Implementation Plan

1. Start the dev server (`pnpm dev` in frontend/)
2. Use Playwright MCP tools to navigate to the application
3. Systematically verify each acceptance criterion
4. Document results with screenshots/snapshots
5. Fix any issues found, re-verify until all criteria pass

**Dependencies**: Task 2-6 (all functional tasks must be complete)

## Test Plan

### Objectives
Validate all 6 acceptance criteria for PBI-2 in an end-to-end browser session.

### Test Scope
Full user workflow from application load through canvas interaction.

### Environment & Setup
- Frontend dev server running on `127.0.0.1:3100`
- Browser automation via Playwright MCP tools

### Key Scenarios

**Scenario 1: Canvas Renders (AC1)**
- Navigate to `/`
- Verify React Flow canvas is visible in the main viewport
- Verify background grid/dots are rendered
- Verify MiniMap and Controls are present

**Scenario 2: Palette Displays (AC2)**
- Verify sidebar palette is visible alongside canvas
- Verify palette contains draggable component items
- Verify each item has a label

**Scenario 3: Drag-and-Drop Creates Node (AC3)**
- Drag an item from the palette onto the canvas
- Verify a new node appears at the drop location
- Verify the node has the correct label/type
- Repeat for a second item to confirm multiple drops work

**Scenario 4: Node Repositioning (AC4)**
- Drag an existing node to a new position
- Verify the node moves to the new position
- Release and verify position persists

**Scenario 5: Zoom and Pan (AC5)**
- Use scroll wheel to zoom in and out
- Verify zoom level changes visually
- Click-drag on canvas background to pan
- Verify viewport shifts
- Use fit-to-view control

**Scenario 6: State Persistence (AC6)**
- Add multiple nodes to the canvas
- Trigger a re-render (e.g., window resize or state update)
- Verify all nodes remain in their positions
- Verify node count has not changed

### Success Criteria
All 6 acceptance criteria pass without manual intervention.

## Verification

- Implemented and executed a Playwright end-to-end acceptance script covering AC1-AC6.
- Verification command sequence:
  - Start app: `pnpm dev --hostname 127.0.0.1 --port 3100`
  - Run E2E: `pnpm test:e2e`
  - Result: `1 passed`
- Reproducible test assets added:
  - Pinned Playwright dependency: `@playwright/test` in `frontend/package.json`
  - `frontend/playwright.config.js`
  - `frontend/tests/e2e/pbi2-cos.spec.js`
- Persisted artifact path from test run:
  - `frontend/test-results/pbi2-cos-final.png`
- AC results:
  - **AC1 passed**: React Flow canvas rendered with background, minimap, and controls visible.
  - **AC2 passed**: Sidebar palette rendered with four draggable items and labels.
  - **AC3 passed**: Drag-and-drop from palette to canvas created new nodes.
  - **AC4 passed**: Existing node was dragged to a new position; node transform changed.
  - **AC5 passed**: Mouse-wheel zoom increased viewport scale and pane drag changed viewport translation.
  - **AC6 passed**: Node count and moved node transform persisted after viewport resize-triggered re-render.
- Additional verification:
  - Ran `pnpm test` (`tsc --noEmit`) in `frontend/`; type check passed.
  - Ran `pnpm lint` in `frontend/`; lint passed after excluding `.next-local/**` generated output in ESLint ignores.
- Internal AI review verdict: `pass`.

## Files Modified

- `docs/delivery/2/2-7.md`
- `docs/delivery/2/tasks.md`
- `frontend/package.json`
- `frontend/pnpm-lock.yaml`
- `frontend/playwright.config.js`
- `frontend/tests/e2e/pbi2-cos.spec.js`
- `frontend/next.config.ts`
- `frontend/.gitignore`
- `frontend/eslint.config.mjs`
- `.gitignore`
