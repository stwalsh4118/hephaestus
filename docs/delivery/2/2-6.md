# [2-6] Integrate Drag-and-Drop from Palette to Canvas

[Back to task list](./tasks.md)

## Description

Wire the drag-and-drop flow end-to-end: when a user drags an item from the palette sidebar and drops it onto the React Flow canvas, a new node is created at the drop position. This is the core interaction that ties the palette and canvas together.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 07:33:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 08:06:16 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 08:11:10 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 08:54:53 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Implement `onDragOver` handler on the React Flow canvas to allow drops (`event.preventDefault()` + set `dropEffect`)
2. Implement `onDrop` handler on the React Flow canvas that:
   - Reads the item type from `dataTransfer`
   - Converts the drop screen coordinates to React Flow canvas coordinates using `screenToFlowPosition`
   - Calls the store's `addNode` action with the correct position and node data
3. Newly created nodes must appear at the exact drop position
4. Newly created nodes must be immediately draggable/repositionable
5. Multiple nodes can be dropped sequentially without issues
6. Each dropped node gets a unique ID

## Implementation Plan

1. Add `onDragOver` and `onDrop` props to the `<ReactFlow>` component in `DiagramCanvas`
2. In `onDrop`, extract item type from `dataTransfer.getData()`
3. Use React Flow's `useReactFlow` hook to access `screenToFlowPosition` for coordinate conversion
4. Call `addNode` from the canvas store with the computed position and item data
5. Generate unique node IDs (e.g., using a counter or `crypto.randomUUID()`)
6. Test the full flow: drag from palette → drop on canvas → node appears

**Dependencies**: Task 2-3 (store with `addNode`), Task 2-4 (canvas component), Task 2-5 (palette with drag)

## Test Plan

- TypeScript compilation passes without errors
- Dragging a palette item over the canvas shows a drop-allowed cursor
- Dropping a palette item on the canvas creates a new node at the drop location
- The new node is visible and labeled correctly
- The new node can be repositioned by dragging
- Dropping multiple items creates multiple distinct nodes
- Canvas state (node count, positions) persists across re-renders
- Browser verification via Playwright: drag from palette → drop on canvas → verify node appears → drag node to new position

## Verification

- Updated `frontend/src/components/canvas/DiagramCanvas.tsx` with:
  - `onDragOver` handler that prevents default and sets `dropEffect="copy"`
  - `onDrop` handler that reads item type from `dataTransfer`, converts screen coordinates using `screenToFlowPosition`, and calls store `addNode`
  - Palette item lookup to populate dropped node label/type/description
- Verified unique IDs are assigned by store-level node ID generator in `addNode` (`frontend/src/store/canvas-store.ts`).
- Ran `pnpm test` (`tsc --noEmit`) in `frontend/`; type check passed.
- Browser verification (Playwright):
  - Started frontend on `127.0.0.1:3100`.
  - Executed automated drag/drop test that dispatches `dragstart` from palette and `drop` on `.react-flow__pane`.
  - Assertion passed: `.react-flow__node` count became `1` after drop.
- Internal AI review verdict: `pass`.
- Deferred findings:
  - `low`: node ID counter currently resets per runtime; if imported/persisted pre-existing IDs are introduced later, ID generation should be derived from loaded state or switched to UUIDs.

## Files Modified

- `frontend/src/components/canvas/DiagramCanvas.tsx`
- `docs/delivery/2/2-6.md`
- `docs/delivery/2/tasks.md`
