# 5-6: E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that all PBI-5 acceptance criteria are met. Tests the complete backend API surface by starting the server and exercising all endpoints through HTTP requests, including diagram CRUD lifecycle, persistence across restarts, WebSocket connectivity, and CORS headers.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 04:38:28 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Verify AC1: Server starts and listens on configurable port
2. Verify AC2: POST /api/diagrams creates a diagram and returns its ID
3. Verify AC3: GET /api/diagrams/:id retrieves a saved diagram
4. Verify AC4: PUT /api/diagrams/:id updates an existing diagram
5. Verify AC5: Diagrams persist to storage and survive server restarts
6. Verify AC6: WebSocket at /ws/status accepts connections and responds to ping
7. Verify AC7: CORS headers allow frontend origin

## Implementation Plan

1. Create E2E test file `backend/test/e2e/api_test.go`
2. Each test starts a real server instance with `httptest.Server` or direct listener
3. Tests use a temporary storage directory cleaned up after each run
4. Full CRUD lifecycle: create → get → update → get (verify update)
5. Restart simulation: create diagram, instantiate new server with same storage dir, verify diagram is retrievable
6. WebSocket test: connect to /ws/status, send ping, verify pong, close
7. CORS test: send request with Origin header, verify CORS response headers

## Test Plan

### Objectives
Validate all 7 acceptance criteria end-to-end against a running server instance.

### Test Scope
- Full HTTP request/response cycle (not mocked)
- Real file-based storage (temp directory)
- Real WebSocket connections

### Key Scenarios

1. **Server startup** — server binds to configured port and responds to health check
2. **Diagram CRUD lifecycle** — POST creates, GET retrieves, PUT updates, GET confirms update
3. **Persistence** — create diagram, stop server, start new server with same storage, GET returns diagram
4. **WebSocket** — upgrade connection at /ws/status, ping/pong exchange, clean close
5. **CORS** — preflight OPTIONS returns correct headers, regular request includes CORS headers
6. **Error handling** — GET non-existent ID returns 404, POST invalid body returns 400

### Success Criteria
All 7 acceptance criteria pass in automated tests.

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
