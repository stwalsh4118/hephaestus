# [4-6] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end Playwright tests verifying all PBI-4 Conditions of Satisfaction: edge drawing between nodes, directional arrows, edge label editing, duplicate edge prevention, JSON export matching PRD schema, and JSON import restoring the diagram.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 11:49:11 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Verify AC1: Edges can be drawn between any two nodes by dragging from source to target handle
2. Verify AC2: Edges display an arrow indicating direction
3. Verify AC3: Edge labels can be added and edited (double-click → type → Enter)
4. Verify AC4: Duplicate edges between the same source-target pair are prevented
5. Verify AC5: Export produces valid JSON matching the PRD Diagram JSON Schema
6. Verify AC6: Importing a previously exported JSON restores the diagram accurately (nodes, positions, edges, configs)

## Implementation Plan

### Files to Create

- **Create** `frontend/tests/pbi4-cos.spec.ts` — Playwright E2E test suite

### Test Scenarios

1. **Edge Drawing** (AC1):
   - Drop two nodes onto canvas
   - Drag from source handle of node A to target handle of node B
   - Verify an edge exists connecting them

2. **Directional Arrow** (AC2):
   - After drawing an edge, verify the edge SVG contains an arrowhead marker

3. **Edge Label Editing** (AC3):
   - Draw an edge between two nodes
   - Double-click the edge label area
   - Type a label (e.g., "reads/writes")
   - Press Enter
   - Verify the label text is displayed on the edge

4. **Duplicate Edge Prevention** (AC4):
   - Draw an edge from node A to node B
   - Attempt to draw another edge from node A to node B
   - Verify only one edge exists between them

5. **JSON Export** (AC5):
   - Drop nodes, configure them, draw edges with labels
   - Click Export button
   - Intercept the download and verify the JSON structure matches PRD schema
   - Verify nodes have correct type, name, position, config
   - Verify edges have correct source, target, label

6. **Round-Trip Import** (AC6):
   - Export a diagram with nodes, edges, and configs
   - Clear the canvas or navigate away
   - Import the exported JSON
   - Verify all nodes are restored (positions, types, configs)
   - Verify all edges are restored (connections, labels)

### Dependencies

- Requires all prior tasks (4-1 through 4-5) to be complete

## Test Plan

### Objectives
Verify end-to-end that all PBI-4 acceptance criteria are met in a real browser environment.

### Test Scope
- Edge creation via handle dragging
- Edge visual rendering (arrows, labels)
- Edge label editing workflow
- Duplicate edge prevention
- Export button and JSON output
- Import button and diagram restoration
- Round-trip fidelity

### Environment & Setup
- Playwright with Chromium
- Dev server running at `http://127.0.0.1:3100`
- Tests create diagram state from scratch (no fixtures)

### Success Criteria
- All 6 test scenarios pass
- No console errors during test execution
- Exported JSON conforms to PRD schema

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
