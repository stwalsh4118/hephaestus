# [4-5] Topology JSON Import

[Back to task list](./tasks.md)

## Description

Implement a function that parses a PRD-schema JSON file and restores the diagram state in the canvas store. Add an Import button with a file picker to the canvas toolbar.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 11:49:11 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 12:09:29 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 12:14:25 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 13:39:47 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create an `importDiagram` function that parses the PRD JSON schema and maps it to React Flow state:
   - Each JSON node → `CanvasNode` with correct `position`, `data` (label, type, description, config)
   - Each JSON edge → `CanvasEdge` with correct `source`, `target`, `data.label`, and `type: EDGE_TYPE_LABELED`
2. Add a `loadDiagram(nodes, edges)` action to the canvas store that replaces the current diagram state
3. Validate the imported JSON: reject if missing required fields (`nodes`, `edges` arrays)
4. Add an Import button to the canvas UI (next to Export)
5. Clicking Import opens a file picker (accept `.json`)
6. After file selection, parse the file, call `importDiagram`, and restore the diagram
7. Round-trip: exporting then importing should restore the diagram identically (nodes, edges, positions, configs, labels)

## Implementation Plan

### Files to Create/Modify

- **Modify** `frontend/src/lib/topology.ts` — Add `importDiagram` function
- **Modify** `frontend/src/store/canvas-store.ts` — Add `loadDiagram` action
- **Modify** `frontend/src/components/canvas/DiagramWorkspace.tsx` — Add Import button with file picker

### Steps

1. In `store/canvas-store.ts`:
   - Add `loadDiagram(nodes: CanvasNode[], edges: CanvasEdge[]): void` — replaces current nodes and edges, resets selectedNodeId
2. In `lib/topology.ts`:
   - Implement `importDiagram(json: DiagramJson)` → returns `{ nodes: CanvasNode[], edges: CanvasEdge[] }`
   - Map each JSON node back to a `CanvasNode` with `type: NODE_TYPE_SERVICE`, correct position, and data fields
   - Map each JSON edge back to a `CanvasEdge` with `type: EDGE_TYPE_LABELED` and data
   - Validate: throw if `nodes` or `edges` arrays are missing
3. In `DiagramWorkspace.tsx`:
   - Add Import button next to Export
   - Create a hidden `<input type="file" accept=".json">` element
   - On Import click: trigger file input click
   - On file change: read file via FileReader, parse JSON, call `importDiagram`, call `loadDiagram`

### Dependencies

- Requires export schema from task 4-4
- Requires store and types from task 4-1
- Requires canvas integration from task 4-3

## Test Plan

- TypeScript compilation passes
- `importDiagram` correctly reconstructs nodes with positions, types, labels, and configs
- `importDiagram` correctly reconstructs edges with labels and types
- `importDiagram` throws on invalid JSON (missing `nodes` or `edges`)
- `loadDiagram` replaces the current store state
- Import button is visible in the UI
- Round-trip test: export → import produces identical diagram state
- File picker accepts only `.json` files

## Verification

- TypeScript compilation passes (`pnpm tsc --noEmit` — zero errors)
- ESLint passes (`pnpm lint` — zero warnings)
- Internal AI review: first pass found 1 high (description round-trip), 2 medium (silent error, validation depth). All fixed. Re-review: pass (0 blocking, 2 low).

## Files Modified

- `frontend/src/lib/topology.ts` — Added `importDiagram` function, `description` field to export, runtime validation helpers
- `frontend/src/store/canvas-store.ts` — Added `loadDiagram` action
- `frontend/src/components/canvas/DiagramWorkspace.tsx` — Added Import JSON button with file picker
